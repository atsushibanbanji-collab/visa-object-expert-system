# ルール管理システム 使用ガイド

## 概要

Webベースのルール管理システムを実装しました。これにより、コードを変更せずにルールの追加・編集・削除が可能になります。

## 主な機能

### 1. ルール一覧表示
- すべてのルールを一覧表示
- ビザタイプでフィルタリング可能
- ルール名、タイプ、条件数、アクション数を表示

### 2. ルールの追加
- Webフォームから新しいルールを作成
- 設定項目:
  - ルール名（一意）
  - ビザタイプ（E, L, B, H, J, ALL）
  - ルールタイプ（#n! 終了ルール / #i 中間ルール）
  - 条件ロジック（AND / OR）
  - 条件（複数設定可能）
  - アクション/結論（複数設定可能）
  - 優先度（質問順序の制御）

### 3. ルールの編集
- 既存ルールの全項目を編集可能
- 条件・アクションの追加/削除

### 4. ルールの削除
- 不要なルールを削除

## アーキテクチャ

### バックエンド

#### データベース
- **SQLite** を使用
- ファイルパス: `backend/data/visa_rules.db`
- 自動的に作成される

#### 主要ファイル

**1. database.py**
- データベース接続の設定
- セッション管理

**2. models/rule_db.py**
- RuleDBモデル（SQLAlchemyモデル）
- ルール情報をデータベースに保存

**3. models/dynamic_rule.py**
- データベースから読み込んだルール情報を元に動的にRuleオブジェクトを生成
- 既存のRuleクラスと互換性を保持

**4. rules/rule_loader.py**
- データベースからルールを読み込む
- `get_rules_by_visa_type_from_db()` 関数

**5. api/rule_management_api.py**
- ルール管理用のCRUD APIエンドポイント
- GET /api/rules - ルール一覧取得
- GET /api/rules/{id} - 特定ルール取得
- POST /api/rules - ルール作成
- PUT /api/rules/{id} - ルール更新
- DELETE /api/rules/{id} - ルール削除
- PUT /api/rules/reorder - ルール順序変更

**6. migrate_rules.py**
- 既存の31ルールをデータベースに移行するスクリプト
- デプロイ時に自動実行される

#### 環境変数

**USE_DATABASE_RULES**
- `true`: データベースからルールを読み込む
- `false`: ハードコードされたルールを使用（デフォルト）
- Render環境では `true` に設定済み

### フロントエンド

#### 主要ファイル

**1. components/RuleManagementPage.js**
- ルール管理画面のメインコンポーネント
- 一覧表示、追加、編集、削除機能

**2. components/RuleManagementPage.css**
- ルール管理画面のスタイル

**3. App.js**
- ルール管理ページへのナビゲーション追加

## 使用方法

### ルール管理画面へのアクセス

1. アプリケーションを開く
2. ヘッダーの「ルール管理」ボタンをクリック

### 新しいルールを追加

1. 「新規ルール作成」ボタンをクリック
2. フォームに必要な情報を入力:
   - ルール名: 例）"32"
   - ビザタイプ: プルダウンから選択
   - ルールタイプ: 終了ルール or 中間ルール
   - 条件ロジック: AND or OR
   - 条件: 「条件を追加」ボタンで複数追加可能
   - アクション: 「アクションを追加」ボタンで複数追加可能
   - 優先度: 数値（小さいほど先に評価される）
3. 「作成」ボタンをクリック

### ルールを編集

1. 編集したいルールの「編集」ボタンをクリック
2. フォームで値を変更
3. 「更新」ボタンをクリック

### ルールを削除

1. 削除したいルールの「削除」ボタンをクリック
2. 確認ダイアログで「OK」をクリック

## ルールの優先度について

優先度（priority）は質問の順序を制御します：

- 小さい数値 → 先に評価される
- 大きい数値 → 後に評価される

**例:**
- 優先度 0: 最初に評価
- 優先度 10: 10番目に評価

## データの永続化

### 開発環境
- `backend/data/visa_rules.db` に保存
- ローカルで永続化される

### 本番環境（Render）
- Renderの無料プランではディスクは一時的
- デプロイごとにデータベースが再作成される
- `migrate_rules.py` が自動実行され、既存の31ルールが再登録される
- **注意**: Web上で追加/編集したルールはデプロイ後に消える

### 対策（有料プラン使用時）
Renderの有料プランでは永続ディスクを使用可能:
1. Render Dashboardで Disk を追加
2. マウントパス: `/app/backend/data`
3. これによりデプロイ後もデータが保持される

## ルールの構造

### 条件（Conditions）
- 質問文または仮説
- 複数の条件を設定可能
- AND/ORロジックで評価

### アクション（Actions）
- ルールが適用された時の結論
- 仮説として作業記憶に追加される
- 他のルールの条件として使用可能

### ルールタイプ

**終了ルール (#n!)**
- 最終的な結論を導くルール
- 「〇〇ビザの申請ができます」など
- 適用されると推論が終了

**中間ルール (#i)**
- 中間的な仮説を導くルール
- 他のルールの条件として使用される
- 推論が継続する

### 条件ロジック

**AND**
- すべての条件が満たされた場合にルールが適用される
- デフォルト

**OR**
- いずれか1つの条件が満たされた場合にルールが適用される

## トラブルシューティング

### ルールが表示されない
1. ブラウザのコンソールでエラーを確認
2. `/api/rules` エンドポイントが正常に動作しているか確認
3. データベースが初期化されているか確認

### ルールが適用されない
1. 条件が正しく設定されているか確認
2. 条件ロジック（AND/OR）が適切か確認
3. 優先度が適切に設定されているか確認

### デプロイ後にルールが消える
- Render無料プランの制限です
- 有料プランで永続ディスクを追加することで解決

## APIエンドポイント一覧

### ルール管理API

```
GET    /api/rules              # ルール一覧取得（クエリパラメータ: visa_type）
GET    /api/rules/{id}         # 特定ルール取得
POST   /api/rules              # ルール作成
PUT    /api/rules/{id}         # ルール更新
DELETE /api/rules/{id}         # ルール削除
PUT    /api/rules/reorder      # ルール順序変更
```

### 診断API（既存）

```
POST /api/consultation/start   # 診断開始
POST /api/consultation/answer  # 回答送信
GET  /api/consultation/status  # 推論状態取得
POST /api/consultation/reset   # 診断リセット
```

## Phase 2: ルール順序管理（実装済み✅）

### アクセス方法
ヘッダーの「順序管理」ボタンをクリック

### 主な機能

#### 1. ドラッグ&ドロップ
- ルールをマウスでドラッグして順序を変更
- リアルタイムでプレビュー表示

#### 2. ボタン操作
- ↑ボタン: 1つ上に移動
- ↓ボタン: 1つ下に移動
- モバイルでも操作しやすい

#### 3. ビザタイプ別管理
- E, L, B, H, J ビザごとに順序管理
- それぞれのビザで独立した順序設定

#### 4. 保存機能
- 変更を検出して通知
- 「順序を保存」ボタンで確定
- 「リセット」ボタンで変更を破棄

### 使用方法

1. **ビザタイプを選択**
   - プルダウンから対象のビザを選択

2. **順序を変更**
   - **方法1**: ルールをドラッグ&ドロップ
   - **方法2**: ↑↓ボタンをクリック

3. **保存**
   - 変更後に「順序を保存」ボタンをクリック

4. **キャンセル**
   - 保存前に「リセット」ボタンで元に戻す

### 注意事項

⚠️ **順序の影響**
- 順序が小さいほど先に評価される
- 質問される順番に直接影響する
- 終了ルール (#n!) の順序は特に重要

💡 **ベストプラクティス**
- よく使われる質問を上位に配置
- 除外判定（impossible）に関わるルールを優先
- 依存関係を考慮して配置

## 今後の拡張案

### Phase 3: ルールのインポート/エクスポート
- JSON形式でルールをエクスポート
- 他の環境で作成したルールをインポート

### Phase 4: バリデーション強化
- ルールの整合性チェック
- 循環参照の検出
- 到達不能なルールの警告

### Phase 5: ルールのテスト機能
- 特定のルールをテスト
- シミュレーション機能

## 技術スタック

### バックエンド
- FastAPI 0.104.1
- SQLAlchemy 2.0.23
- SQLite（データベース）
- Pydantic 2.5.0（バリデーション）

### フロントエンド
- React 18
- Axios（HTTP クライアント）
- CSS3

## まとめ

ルール管理システムにより、以下が実現されました：

✅ コード変更なしでルールの追加・編集・削除が可能
✅ Webブラウザから直感的に操作できる
✅ 既存のルールエンジンとの互換性を保持
✅ データベースベースの柔軟な管理
✅ 質問順序のカスタマイズが可能

非エンジニアでもルールを管理できるようになり、ビザ制度の変更に素早く対応できます。
